pipeline {
    agent any

    environment {
        // Define environment variables
        SONAR_HOME = tool name: "SonarQubeInvoice"
    }

    options {
        timeout(time: 10, unit: 'MINUTES') // Increase the timeout for the entire pipeline
    }

    stages {
        stage("Start") {
            steps {
                echo "Start pipeline"
            }
        }

        stage("Checkout Code from Github") {
            steps {
                git url: "https://github.com/Psonare56/Invoice-Generator.git", branch: "Devops"
            }
        }

        stage("SonarQube Quality Analysis") {
            steps {
                script {
                    // Run SonarQube analysis
                    withSonarQubeEnv('SonarQubeInvoice') {
                        sh "${SONAR_HOME}/bin/sonar-scanner -Dsonar.projectName=Invoice-Generator -Dsonar.projectKey=Invoice-Generator"
                    }
                }
            }
        }

        stage("OWASP Dependency Check") {
            options {
                timeout(time: 15, unit: 'MINUTES') // Set a specific timeout for the OWASP stage
            }
            steps {
                dependencyCheck additionalArguments: '--scan ./', odcInstallation: 'OWASPdcInvoice'
                dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
            }
        }

        stage("End of code") {
            steps {
                echo "End of code"
            }
        }
    }
}
